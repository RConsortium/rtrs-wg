---
output: html_document
editor_options: 
  chunk_output_type: console
---
## Disposition

### rtables

```{r, comment=NA}
resetSession()

library(dplyr)
library(magrittr)
library(rtables)

data("cadsl", package = "random.cdisc.data")
r_adsl <- cadsl %>%
  select(USUBJID, EOSSTT, DCSREAS) %>%
  filter(EOSSTT != "COMPLETED")

lyt <- basic_table()

build_table(lyt, r_adsl)

```

### flextable

```{r}
resetSession()

library(survival)
library(tidyverse)
library(flextable)
library(glue)

adsl <- cadsl |>
  select(USUBJID, TRT01A, EOSSTT, DCSREAS)

labels <- tools::toTitleCase(tolower(levels(adsl$DCSREAS)))
names(labels) <- levels(adsl$DCSREAS)

# data parts calculations
part_header <- adsl |> count(TRT01A, name = "n_part")

part_completed <- adsl |> filter(EOSSTT %in% "COMPLETED") |> 
  mutate(DCSREAS = "") |>
  count(TRT01A, EOSSTT, DCSREAS)

part_discontinued <- adsl |> 
  filter(EOSSTT %in% "DISCONTINUED") |> 
  count(TRT01A, EOSSTT, DCSREAS)

part_death <- cadsl |> 
  filter(EOSSTT %in% "DISCONTINUED", DCSREAS %in% "DEATH") |> 
  count(TRT01A, EOSSTT, DTHCAUS) |> 
  mutate(EOSSTT = forcats::fct_expand(EOSSTT, "Death Cause"),
         EOSSTT = "Death Cause",
         DTHCAUS = tools::toTitleCase(tolower(DTHCAUS))
         ) |> 
  rename(DCSREAS = DTHCAUS)

dat <- bind_rows(
  part_completed, 
  part_discontinued, 
  part_death) |> 
  inner_join(part_header, by = "TRT01A") |> 
  mutate(percent = n / n_part, n_part = NULL)
dat
```

Now the flextable creation with help of `tabulator()`. 

```{r}

tab <- tabulator(
  dat,
  rows = c("EOSSTT", "DCSREAS"),
  columns = "TRT01A",
  `content_cell` = as_paragraph(fmt_n_percent(n, percent))
)
ft <- as_flextable(tab, spread_first_col = TRUE)

TRT_COUNTS <- setNames(part_header$n_part, part_header$TRT01A)
for (TRT_COD in names(TRT_COUNTS)) {
  ft <- append_chunks(x = ft, part = "header", i = 1,
                      j = tabulator_colnames(tab, columns = "content_cell", TRT01A %in% !!TRT_COD),
                      as_chunk(TRT_COUNTS[TRT_COD], formatter = function(n) sprintf("\n(N=%.0f)", n)))
}

ft <- ft |> 
  labelizor(
    labels = c(labels, DCSREAS = "", ANY = "Number of patients", 
               COMPLETED = "Completed", DISCONTINUED = "Discontinued"), 
    j = "DCSREAS", part = "all") |> 
  align(i = ~!is.na(EOSSTT), align = "left") |> 
  prepend_chunks(i = ~is.na(EOSSTT), j = "DCSREAS", as_chunk("\t")) |> 
  autofit()
ft
```


### tables

```{r}
resetSession()
adsl <- cadsl

levels(adsl$EOSSTT)  <- tools::toTitleCase(tolower(levels(adsl$EOSSTT)))
levels(adsl$DCSREAS) <- tools::toTitleCase(tolower(levels(adsl$DCSREAS)))
levels(adsl$DTHCAUS) <- tools::toTitleCase(tolower(levels(adsl$DTHCAUS)))

library(tables)
table_options(doCSS = TRUE)

subject_counts <- table(adsl$ARM)

countpercentid <- function(num, ARM) {
  n <- length(unique(num))
  sprintf("%d (%.2f%%)", 
          length(unique(num)), 
          100*n/subject_counts[ARM[1]])
}

count <- function(x) sprintf("(N=%d)", length(x))

heading <- tabular(Heading("")*1*Heading("")*count  ~
             Heading()*TRT01A, data = adsl)

part1 <- tabular( Heading("")*EOSSTT*DropEmpty()*
                   Heading("")*1*
                   Heading()*countpercentid*Arguments(ARM = TRT01A)*
                     Heading()*USUBJID ~
             Heading()*TRT01A, data = subset(adsl, EOSSTT != "Discontinued"))

part2 <- tabular( Heading("")*EOSSTT*
                    Heading("")*DCSREAS*DropEmpty()*
                   Heading()*countpercentid*Arguments(ARM = TRT01A)*
                     Heading()*USUBJID ~
             Heading()*TRT01A, data = subset(adsl, EOSSTT == "Discontinued" & DCSREAS != "Death"))

part3 <- tabular( Heading("")*DCSREAS*
                    Heading("")*DTHCAUS*DropEmpty()*
                   Heading()*countpercentid*Arguments(ARM = TRT01A)*
                     Heading()*USUBJID ~
             Heading()*TRT01A, data = subset(adsl, EOSSTT == "Discontinued" & DCSREAS == "Death"))

rbind(heading, part1, part2, part3)
```
