---
output: html_document
editor_options: 
  chunk_output_type: console
---
## Disposition

### rtables

```{r, comment=NA}
library(dplyr)
library(magrittr)
library(rtables)

data("cadsl", package = "random.cdisc.data")
r_adsl <- cadsl %>%
  select(USUBJID, EOSSTT, DCSREAS) %>%
  filter(EOSSTT != "COMPLETED")

lyt <- basic_table()

build_table(lyt, r_adsl)

```

### flextable

```{r}
library(survival)
library(tidyverse)
library(flextable)
library(glue)

adsl <- cadsl |>
  select(USUBJID, TRT01A, EOSSTT, DCSREAS)

labels <- tools::toTitleCase(tolower(levels(adsl$DCSREAS)))
names(labels) <- levels(adsl$DCSREAS)

# data parts calculations
part_header <- adsl |> count(TRT01A, name = "n_part")

part_completed <- adsl |> filter(EOSSTT %in% "COMPLETED") |> 
  mutate(DCSREAS = "") |>
  count(TRT01A, EOSSTT, DCSREAS)

part_discontinued <- adsl |> 
  filter(EOSSTT %in% "DISCONTINUED") |> 
  count(TRT01A, EOSSTT, DCSREAS)

part_death <- cadsl |> 
  filter(EOSSTT %in% "DISCONTINUED", DCSREAS %in% "DEATH") |> 
  count(TRT01A, EOSSTT, DTHCAUS) |> 
  mutate(EOSSTT = forcats::fct_expand(EOSSTT, "Death Cause"),
         EOSSTT = "Death Cause",
         DTHCAUS = tools::toTitleCase(tolower(DTHCAUS))
         ) |> 
  rename(DCSREAS = DTHCAUS)

dat <- bind_rows(
  part_completed, 
  part_discontinued, 
  part_death) |> 
  inner_join(part_header, by = "TRT01A") |> 
  mutate(percent = n / n_part, n_part = NULL)
dat
```

Now the flextable creation with help of `tabulator()`. 

```{r}

tab <- tabulator(
  dat,
  rows = c("EOSSTT", "DCSREAS"),
  columns = "TRT01A",
  `content_cell` = as_paragraph(fmt_n_percent(n, percent))
)
ft <- as_flextable(tab, spread_first_col = TRUE)

TRT_COUNTS <- setNames(part_header$n_part, part_header$TRT01A)
for (TRT_COD in names(TRT_COUNTS)) {
  ft <- append_chunks(x = ft, part = "header", i = 1,
                      j = tabulator_colnames(tab, columns = "content_cell", TRT01A %in% !!TRT_COD),
                      as_chunk(TRT_COUNTS[TRT_COD], formatter = function(n) sprintf("\n(N=%.0f)", n)))
}

ft <- ft |> 
  labelizor(
    labels = c(labels, DCSREAS = "", ANY = "Number of patients", 
               COMPLETED = "Completed", DISCONTINUED = "Discontinued"), 
    j = "DCSREAS", part = "all") |> 
  align(i = ~!is.na(EOSSTT), align = "left") |> 
  prepend_chunks(i = ~is.na(EOSSTT), j = "DCSREAS", as_chunk("\t")) |> 
  autofit()
ft
```

