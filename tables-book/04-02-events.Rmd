---
output: html_document
editor_options: 
  chunk_output_type: console
---

## Adverse Event Tables

We will use the `ex_adae` data included within the `formatters` package.

```{r, comment=NA}
head(formatters::ex_adae)
```


### `rtables` Only

Adverse Events by ID

```{r, comment=NA}
resetSession()
library(rtables)

s_events_patients <- function(x, labelstr, .N_col) {
  in_rows(
    "Patients with at least one event" =
      rcell(length(unique(x)) * c(1, 1 / .N_col), format = "xx (xx.xx%)"),

    "Total number of events" = rcell(length(x), format = "xx")
  )
}

table_count_per_id <- function(df, .N_col, termvar = "AEDECOD", idvar = "USUBJID") {

  x <- df[[termvar]]
  id <- df[[idvar]]

  counts <- table(x[!duplicated(paste0(id, x))])

  in_rows(
    .list = lapply(counts,
                   function(xi) rcell(c(xi, xi/.N_col), "xx (xx.xx%)")),
    .labels = names(counts)
  )
}

lyt <- basic_table(show_colcounts = TRUE) %>%
    split_cols_by("ARM") %>%
    analyze("USUBJID", afun = s_events_patients) %>%
    split_rows_by("AEBODSYS", child_labels = "visible", 
                  split_fun = trim_levels_in_group("AEDECOD"),
                  section_div = " ") %>%
    summarize_row_groups("USUBJID", cfun = s_events_patients) %>%
    analyze("AEDECOD", table_count_per_id, show_labels = "hidden", indent_mod = -1)

build_table(lyt, ex_adae, alt_counts_df = ex_adsl)
```

### gt

```{r}
resetSession()

library(tidyverse)
library(gt)

ex_adsl <- formatters::ex_adsl
ex_adae <- formatters::ex_adae

header_n <- ex_adsl |> 
  dplyr::group_by(ARM) |> 
  dplyr::summarize(
    N = dplyr::n_distinct(USUBJID)
  ) 

col_lbls <- header_n |> 
  dplyr::transmute(
    ARMN = sprintf("%s  \n  (N=%i)", ARM, N)
  ) |> 
  dplyr::group_split(ARMN) 

summary_ex <- merge(ex_adae, header_n, by = "ARM") |> 
  dplyr::group_by(ARM) |> 
  dplyr::summarize(
    n = dplyr::n_distinct(USUBJID),
    n_indiv = dplyr::n(),
    pct_tot = n/mean(N),
    .groups = "drop"
  ) |> 
  dplyr::mutate(AEDECOD = "Patients with at least one event")

indivsummary_ex <- merge(ex_adae, header_n, by = "ARM") |> 
  dplyr::group_by(ARM, AEBODSYS) |> 
  dplyr::summarize(
    n = dplyr::n_distinct(USUBJID),
    pct_tot = n/mean(N),
    n_indiv = dplyr::n(),
    .groups = "drop"
  ) |> 
  dplyr::mutate(AEDECOD = "Patients with at least one event")

bodsys_summary <- merge(ex_adae, header_n, by = "ARM") |> 
  dplyr::group_by(ARM, AEBODSYS, AEDECOD) |> 
  dplyr::summarize(
    n = dplyr::n_distinct(USUBJID),
    pct_tot = n/mean(N),
    n_indiv = dplyr::n(),
    .groups = "drop"
  ) 

ex_tbl <- dplyr::bind_rows(summary_ex, indivsummary_ex, bodsys_summary) |> 
  tidyr::pivot_wider(
    id_cols = c(AEBODSYS, AEDECOD), 
    names_from = ARM, 
    values_from = c(n, pct_tot, n_indiv)
    ) |> 
  dplyr::mutate(
    across(where(is.numeric), ~ifelse(is.na(.), 0, .)),
    AEBODSYS = forcats::fct_na_value_to_level(AEBODSYS, level = " ")
      )

ex_tbl |> 
  gt(
    rowname_col = "AEDECOD",
    groupname_col = "AEBODSYS"
  ) |> 
  fmt_percent(
    columns = starts_with("pct"),
    decimals = 1
  ) |> 
  cols_merge_n_pct(
    col_n = "n_A: Drug X",
    col_pct = "pct_tot_A: Drug X"
  ) |> 
  cols_merge_n_pct(
    col_n = "n_B: Placebo",
    col_pct = "pct_tot_B: Placebo"
  ) |> 
  cols_merge_n_pct(
    col_n = "n_C: Combination",
    col_pct = "pct_tot_C: Combination"
  ) |> 
  tab_spanner(
    label = md(col_lbls[[1]]),
    columns = c("n_A: Drug X", "n_indiv_A: Drug X")
  ) |> 
  tab_spanner(
    label = md(col_lbls[[2]]),
    columns = c("n_B: Placebo", "n_indiv_B: Placebo")
  ) |> 
  tab_spanner(
    label = md(col_lbls[[3]]),
    columns = c("n_C: Combination", "n_indiv_C: Combination")
  ) |> 
  cols_label(
    .list = list(
      "n_A: Drug X" = md("n  \n  (% of subjects)"),
      "n_indiv_A: Drug X" = md("Total number  \n  of events"),
      "n_B: Placebo" = md("n  \n  (% of subjects)"),
      "n_indiv_B: Placebo" = md("Total number  \n  of events"),
      "n_C: Combination" = md("n  \n  (% of subjects)"),
      "n_indiv_C: Combination" = md("Total number  \n  of events")
    )
  ) |> 
  cols_align(
    columns = 3:11,
    align = "center"
  ) |> 
  cols_width(
    .list = list(
      1:2 ~ px(250),
      3:11 ~ px(100)
    )
  ) |> 
  tab_stub_indent(
    rows = 2:18,
    indent = 2
  )
```


### flextable

```{r message=FALSE}
resetSession()
ex_adsl <- formatters::ex_adsl
ex_adae <- formatters::ex_adae
library(flextable)
library(tidyr)
library(dplyr)
library(forcats)
ae_tabulator <- function(ADSL, ADAE){
  
  
  subject_cts <- group_by(ADSL, ARM) |> 
    summarise(n_subject = n())
  
  all_event_total_cts <- group_by(ADAE, ARM) |> 
    summarise(n_usub = n_distinct(USUBJID), n_events = n())
  
  aebodsys_cts <- group_by(ADAE, ARM, AEBODSYS) |> 
    summarise(n_usub = n_distinct(USUBJID), n_events = n(),
              .groups = "drop")
  
  aedecod_cts <- group_by(ADAE, ARM, AEBODSYS, AEDECOD) |> 
    summarise(n_usub = n_distinct(USUBJID), n_events = n(),
              .groups = "drop")
  
  x <- bind_rows(all_event_total_cts, aebodsys_cts, aedecod_cts) |> 
    mutate(
      AEBODSYS = fct_expand(AEBODSYS, "ALL1") |> fct_relevel("ALL1"),
      AEDECOD = fct_expand(AEDECOD, "ALL2") |> fct_relevel("ALL2")
    ) |> 
    left_join(subject_cts, by = "ARM") |> 
    replace_na(replace = list(AEBODSYS = "ALL1", AEDECOD = "ALL2")) |>
    arrange(AEBODSYS, AEDECOD) |> 
    mutate(pct = n_usub / n_subject)
  attr(x, "ARM_COUNTS") <- setNames(subject_cts$n_subject, subject_cts$ARM)
  x
  
}

# Labels for `flextable::labelizor()`:
AEDECOD_LABELS <- c(
  ALL1 = "Patients with at least one event", 
  ALL2 = "Patients with at least one event")
HEADER_LABELS <- c(
  AEDECOD = "dictionary-derived term\n\tbody system or organ class",
  nevents = "Total number\nof events", 
  n = "n\n(% of subjects)",
  "ARM A" = "Treatment A",
  "ARM B" = "Treatment B"
)

# `tabulator()` call:
dat <- ae_tabulator(ADSL = ex_adsl, ADAE = ex_adae)
ARM_COUNTS <- attr(dat, "ARM_COUNTS")

tab <- tabulator(
  dat,
  rows = c("AEBODSYS", "AEDECOD"),
  columns = "ARM",
  `n` = as_paragraph(fmt_n_percent(n_usub, pct)),
  `nevents` = as_paragraph(n_events)
)

.ARM_COUNTS <- ARM_COUNTS

# flextable creation:

ft <- as_flextable(tab, spread_first_col = TRUE) |> 
  fontsize(size = 9, part = "all") |>
  prepend_chunks(
    i = ~ is.na(AEBODSYS), j = 1, 
    as_chunk("\t")
  )

for(ARM_COD in names(ARM_COUNTS)){
  ft <- append_chunks(
    x = ft, 
    part = "header", 
    i = 1, 
    j = tabulator_colnames(tab, columns = "n", ARM %in% !!ARM_COD),
    as_chunk(ARM_COUNTS[ARM_COD], 
             formatter = fmt_header_n)
  )
}
ft <- labelizor(
    ft, 
    j = "AEDECOD", 
    part = "body", 
    labels = AEDECOD_LABELS) |> 
  labelizor(part = "header", labels = HEADER_LABELS) |> 
  align(j = 1, align = "left") |> 
  autofit()

ft
```

### tables

The `tables` package normally generates tables from single datasets, while this
kind of table requires information from two:  `adsl` and `ex_adae`.
One way to handle this would be to add the `adsl` patient count 
information to a copy of the `ex_adae` table.  In this code we
use a different approach:  we generate one table of patient counts
to produce the heading lines, and a second table with the adverse
event data, then use `rbind` to combine the two tables.

```{r}
resetSession()

library(tables)
table_options(doCSS = TRUE)

ex_adae <- formatters::ex_adae

subject_counts <- table(adsl$ARM)

countpercentid <- function(num, ARM) {
  n <- length(unique(num))
  sprintf("%d (%.2f%%)", 
          length(unique(num)), 
          100*n/subject_counts[ARM[1]])
}

count <- function(x) sprintf("(N=%d)", length(x))

heading <- tabular(Heading("")*1*
                     Heading("")*count ~ 
                   Heading()*ARM, data = adsl)

body <- tabular( Heading("Patients with at least one event")*1*
                   Heading("")*countpercentid*Arguments(ARM = ARM)*
                   Heading()*USUBJID +
                 Heading("Total number of events")*1*Heading("")*1 +
                 Heading()*AEBODSYS*
                   (Heading("Patients with at least one event")*
                      Percent(denom = ARM, fn = countpercentid)*
                      Heading()*USUBJID +
                    Heading("Total number of events")*1 +
                    Heading()*AEDECOD*DropEmpty()*
                      Heading()*Percent(denom = ARM, fn = countpercentid)*
                      Heading()*USUBJID) ~ 
                 Heading()*ARM, 
                 data = ex_adae )

tab <- rbind(heading, body)
useGroupLabels(tab, indent = "&emsp;", extraLines = 1)
```

### tidytlg

```{r}
resetSession()
library(dplyr)
library(tidytlg)

adsl <- formatters::ex_adsl
adae <- formatters::ex_adae %>% 
  mutate(TRTEMFL = "Y")

# Create analysis population counts
tbl1 <- freq(adsl,
             rowvar = "SAFFL",
             colvar = "ARM",
             statlist = statlist("n"),
             rowtext = "Analysis Set: Safety Population",
             subset = SAFFL == "Y")

# Create counts (percentages) for patients with at least one event
tbl2 <- freq(adae,
             denom_df = adsl,
             rowvar = "TRTEMFL",
             colvar = "ARM",
             statlist = statlist("n (x.x%)"),
             rowtext = "Patients with at least one event",
             subset = TRTEMFL == "Y")

# Create counts (percentages) of AE by AEBODSYS and AEDECOD
tbl3a <- nested_freq(adae,
                    denom_df = adsl,
                    rowvar = "AEBODSYS*AEDECOD",
                    colvar = "ARM",
                    statlist = statlist("n (x.x%)"))

# Create total event counts by AEBODSYS
tbl3b <- freq(adae,
              rowvar = "AEBODSYS",
              colvar = "ARM",
              statlist = statlist("n", distinct = FALSE)) %>% 
  rename(AEBODSYS = label) %>% 
  mutate(label = "Total number of events",
         nested_level = 0)

# interleave tbl3a and tbl3b by AEBODSYS
tbl3 <- bind_rows(tbl3a, tbl3b) %>% 
  arrange(AEBODSYS, nested_level)

# combine analysis results together
tbl <- bind_table(tbl1, tbl2, tbl3) %>% 
  select(-AEBODSYS)

# output the analysis results
gentlg(huxme       = tbl,
       format      = "HTML",
       print.hux = FALSE,
       file        = "Table x.x.x.x",
       orientation = "portrait",
       title = "Adverse Events Summary - Safety Analysis Set",
       colheader = c("","A: Drug X","B: Placebo","C: Combination"))

```

### tfrmt
Rather than starting with an [ADaM](https://www.cdisc.org/standards/foundational/adam), {tfrmt} assumes users will start with an ARD (Analysis Results Dataset), because of this, making this table will be split into two parts, first to make the ARD and second to format the table. 
```{r}
resetSession()
library(tidyverse)
library(tfrmt)

# Make ARD 
ex_adsl <- formatters::ex_adsl
ex_adae <- formatters::ex_adae 

big_n <- ex_adsl |> 
  dplyr::group_by(ARM) |> 
  dplyr::summarize(
    N = dplyr::n_distinct(USUBJID)
  ) 

adae_with_n <- ex_adae |> 
  dplyr::left_join(big_n, by = "ARM")

calc_tot_and_any <- function(.data){
  .data |>
    dplyr::reframe(
      n_subj = n_distinct(USUBJID),
      pct_subj = n_subj/N,
      n_evnts = n()
    ) |> 
    dplyr::distinct() |>
    tidyr::pivot_longer(c("n_subj", "pct_subj", "n_evnts")) |> 
    dplyr::mutate(label = dplyr::case_when(
      name %in% c("n_subj", "pct_subj") ~ "Patients with at least one event",
      name == "n_evnts" ~ "Total number of events"
    ))
}

overall <- adae_with_n |> 
  dplyr::group_by(ARM) |> 
  calc_tot_and_any() |>
  dplyr:: mutate(AEBODSYS = label)

bdysys_overall <- adae_with_n |> 
  dplyr::group_by(ARM, AEBODSYS) |> 
  calc_tot_and_any()

aeterm_sum <- adae_with_n |> 
  dplyr::group_by(ARM, AEBODSYS, AETERM) |> 
  dplyr::reframe(
      n_subj = n_distinct(USUBJID),
      pct_subj = n_subj/N) |> 
  dplyr::distinct() |>
  tidyr::pivot_longer(ends_with("subj")) |> 
  dplyr::rename(label = AETERM)

header_n <- big_n |> 
  dplyr::rename(value = N) |> 
  dplyr::mutate(name = "header_n")

ae_ard <- dplyr::bind_rows(
  overall, 
  bdysys_overall,
  aeterm_sum,
  header_n
)

## Format Table 
tfrmt(
  column = ARM,
  group = c("AEBODSYS"),
  param = name,
  value = value,
  label = label, 
) |>
  # Then we cam combine it with an n percent template 
tfrmt_n_pct(n = "n_subj",
            pct = "pct_subj",
  pct_frmt_when = frmt_when("==1" ~ "", 
                            ">.99" ~ "(>99%)", 
                            "==0" ~ "", 
                            "<.01" ~ "(<1%)", 
                            "TRUE" ~ frmt("(xx.x%)", transform = ~.*100))
  ) |>
  #Finally we are going to add some additional formatting
  tfrmt(
    body_plan = body_plan(
      frmt_structure("n_evnts" = frmt("XXX"))
    ),
    big_n = big_n_structure("header_n"),
    # Aligning on decimal places and spaces
    col_style_plan = col_style_plan(
      col_style_structure(col = matches("[A-Z]:.*"),
                          align = c(".", " "))
    )
  ) |> 
  print_to_gt(ae_ard)

```


